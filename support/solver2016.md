# solver2016.py

`solver2016.py`は、アルゴリズムデザインコンテストの2016年版ルールに従った、簡易ソルバーです。

アルゴリズムデザインコンテストの運営サイドで、問題作成を行うときに、問題が適切かどうか（簡単すぎないか、本当に解が存在するのか、…）を見極めるときに使ってもらうために、開発しました。

問題作成ツール[nlconv.pl](https://github.com/dasadc/conmgr/blob/master/support/nlconv.md)も、あわせて参考にしてください。
サンプル問題データ[sample.xlsx](https://github.com/dasadc/conmgr/blob/master/support/sample.xlsx)の問題「Q4」（ワークシートQ4.1とQ4.2）を例にしながら説明します。

## 使い方

### 問題データを用意する

`nlconv.pl`を使って、Excelファイル(`*.xlsx`)から、問題を作成できますので、ぜひご利用ください。

実行例

    nlconv.pl sample.xlsx

シートごとに問題データが生成されます。このうち、`sample_Q4_adc.txt`が、2016年版ルールの問題データです。

### `solver2016.py`を実行する

まず、問題データを変換します。

実行例

    solver2016.py --project-dir sample_Q4 --convert sample_Q4_adc.txt

ディレクトリsample_Q4が作成され、その中にファイルがたくさん作られます。この例では、120通りの問題が生成されています。2層あるので、実際にはさらに2倍の、240個の問題ファイルがあります。

変換後の問題データを解きます。120通りの問題には、0から119までの番号が割り当てられています。0番の問題データを解くには、以下のようにします。

    solver2016.py --project-dir sample_Q4 --solve 0

いろいろメッセージが出ますが、最後のほうで、以下のように出ます。

	afile =  sample_Q4_adc.0.A.txt
	judges =  [[True, 0.007246376811594203]]
	gif =  ['sample_Q4/sample_Q4_adc.0.A.0.gif', 'sample_Q4/sample_Q4_adc.0.A.1.gif']


- afileは、回答ファイルです
- judgesで、Trueとあれば、解が得られた、ということです。数字は、解の品質です
- gifは、解の画像ファイルです。層ごとにファイルが出力されます

つづいて、1番の問題を解くと

    solver2016.py --project-dir sample_Q4 --solve 1

結果は

	judges =  []
	best =  (None, -1)

これは、解が無かったということです。

`sample.xlsx`に描かれている解は、56番の問題データに対応します。

    solver2016.py --project-dir sample_Q4 --solve 56

結果は以下のようになります。

	afile =  sample_Q4_adc.56.A.txt
	judges =  [[True, 0.005434782608695652]]
	gif =  ['sample_Q4/sample_Q4_adc.56.A.0.gif', 'sample_Q4/sample_Q4_adc.56.A.1.gif']


以下のコマンドで、各種情報を表示できます。

    solver2016.py --project-dir sample_Q4 --info

`output_info`の行以降に、これまで解いた問題の結果が見られます。afileとjudgesの行があれば、その番号の問題は、すでに実行済ということです。

	[output_info]
	  [0]
		[L1]  {'map_line_num': [0, 1, 2, 3, 4, 5, 8, 9, 10], 'ofile': 'sample_Q4_adc.0.L1.txt'}
		[L2]  {'map_line_num': [0, 1, 2, 3, 4, 5, 6, 7], 'ofile': 'sample_Q4_adc.0.L2.txt'}
		[afile]  sample_Q4_adc.0.A.txt
		[judges]  [[True, 0.007246376811594203]]
	  [1]
		[L1]  {'map_line_num': [0, 1, 2, 3, 4, 5, 8, 9, 10], 'ofile': 'sample_Q4_adc.1.L1.txt'}
		[L2]  {'map_line_num': [0, 1, 2, 3, 4, 5, 6, 7], 'ofile': 'sample_Q4_adc.1.L2.txt'}
		[judges]  None

### 備考

詳細は、このあとの原理を見てもらうと判明しますが、via数、層数が多いと、convertの処理時間が延びます。

[NL_Q01.txt](https://github.com/dasadc/conmgr/blob/master/sample/01/NL_Q01.txt)は、viaが7個、層が2層なので、`7!*2=10080`個の問題ファイルが生成されます



## 原理

内部では、DAシンポジウム2014で優勝した神戸大学のソルバーを利用しているため、以下のような原理で動作します。

1. 2016年版ルールの問題を、2015年以前のルールの問題に変換する
2. 2015年以前のルールの問題を解く
3. 複数の解が得られた場合は、解の品質がよいものを選択する
4. 解けた解を、2016年版ルールの解の形式へ変換する

### 問題を変換する

問題の変換は、3ステップで行います。

1. viaに、番号を割り当てる
2. 層ごとに、分割する
3. 線の番号を、再割り当てする

viaの名前に、線の番号を割り当てます。
viaが5個あるなら、`5!=5*4*3*2*1=120`通り、出てきます。

層ごとに、問題を分割します。
層が2つあれば、2個の問題へ、分割されます。

分割されたそれぞれの問題で、線の番号をつけなおします。これは、ルールで、線の番号は1から連続で割り当てられることになっているためです。

たとえば、viaが5個、2層の問題ならば、`120*2=240`個の問題ファイルが生成されます。

#### `--candidates`オプションを使って、場合分けを明示的に指定する

viaの個数が`n`のとき、viaへの線の番号割り当ては`n!`通りあるので、viaの個数が増えたら、組み合わせ爆発します。
そこで、コマンドライン引数`--candidates FILE.csv`を指定することで、明示的に場合分けを指定できるようにしました。

`FILE.csv`は以下のような内容の、CSV形式のファイルです。

    a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r
    a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,r,q
    a,b,c,d,e,f,g,h,i,j,k,l,m,n,p,o,q,r
    a,b,c,d,e,f,g,h,i,j,k,l,m,n,p,o,r,q

- viaの名前を、順番に列挙する。何行あってもよい
- 列挙した順番に、線の番号が、小さい順に、対応づけされていく

実行例

    solver2016.py --project-dir Q9 --convert sample_1_shibata-san_Q9_adc.txt --candidates candidates_Q9.csv 


### 問題を解く

バカ正直な方法は、viaへの番号割り当て（例では、120通り）を、exhaustiveに解くことです（2層なら、2*120=240回、ソルバーを実行する）。
heuristicな方法、既存の解探索アルゴリズムの応用、いろいろ考えられると思いますが、いまのところ何も実装されていません。

`solver2016.py`では、viaへの番号割り当てのケースごとに、番号が割り当てられます（120通りあるなら、0から119まで）。この番号を指定して、問題を解きます。

利用しているソルバーでは、1つの問題について、最大5個の解を出力します。この複数の解の中から、**解の品質**がもっともよいものを1つだけ選択します。

ここで利用している2014年版ソルバーには、少し問題があります。2015年版ルールから、空き地が多くある問題が登場したのですが、この2014年版ソルバーは、空き地があるときに、余計な線を引いた解を出力してしまいます。余計な線を消したり、迂回している線をまっすぐに引きなおす処理を、`nlcheck.py`を使って行っています。

すべての層で、解が得られたら、オリジナルの問題にあわせた解の形式にした、回答データを作ります。線の番号を変えているので、元の番号に戻したり、層ごとにわかれている回答データを、LAYER記述を追加して１つの回答データファイルにします。


# トラブルシューティング

## AttributeError: 'module' object has no attribute 'full'

以下のようなエラーメッセージが出るとき。

<pre><code>
    xd = np.full( xmat.shape, -1, np.integer )
AttributeError: 'module' object has no attribute 'full'
</code></pre>


numpyのバージョンが古いとき、このエラーになります。
CentOS 6では、パッケージでインストールされるnumpyのバージョンが古すぎるため、このエラーが出ます。



# 更新履歴

- 2016-09-12 回答データを作成する`generate_A_data`にて、X座標とY座標を間違えるという凡ミスを修正。盤サイズが正方形でないとき、回答データファイルが、間違った桁で改行されてました。
- 2016-09-12 コマンドラインオプション「--candidate」を追加しました。

