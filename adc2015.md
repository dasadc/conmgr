# アルゴリズムデザインコンテスト(ADC)サービスの利用方法

DAシンポジウム2015にて開催されるアルゴリズムデザインコンテスト(ADC)では、クライアント・サーバ方式による、自動運用システムを導入します。

問題データの配布、回答データの提出、スコア計算、スコア表示などが、すべてネットワーク経由で自動的に行われます。


## 必要なソフトウェア

以下のどちらかをご用意ください。

|名称        |参考                    |
|------------|----------------------- |
|Python 2.7  |https://www.python.org/ |
|curl        |http://curl.haxx.se/    |

pythonとcurlは、LinuxやMacなどでは、ほぼ標準でインストールされています。Windowsでは、申し訳ありませんが各自でインストールをお願いします。

ADCのサービスは、Web APIによって提供されています。

そのため、自作プログラムからAPIを使って、ADCのサービスを利用することも可能です。その場合、curlを用いてAPIの利用方法を確認できます。


## 注意事項

`das-adc.appspot.com`は、Google App EngineにてホスティングされたWebサービスです。

- Google App Engineを無料の範囲内で利用しているため、大量アクセスによる負荷テストのようなことは、ご遠慮ください。
- アルゴリズムデザインコンテストの本番では、Google App Engineを使わず、ローカル環境で実行するので、課金問題は発生しません。


## ADCサービスを利用するためのツール

adccliを使う方法(要python 2.7)と、curlを使う方法(要curl)の２通りを紹介します。

### コマンドラインツール adccli （クライアントのサンプル実装）

ADCサービスを利用するためのコマンドラインツールadccliを用意しました。Python 2.7で記述しています。

実行のためには、以下の3つのファイルが必要です。
- adccli
- adcclient.py
- http_post.py

[ZIPファイル](https://github.com/dasadc/conmgr/archive/master.zip)をダウンロードして、ZIPを展開すると、`conmgr-master/client/`にファイルがあります。

Windows用バッチファイルのサンプル`adccli.bat`もあります。

adccliを実行するにあたって、ZIPファイル中の上記のファイル以外は不要ですので、削除してもかまいません。中身をじっくりと見てもらっても大丈夫です。ご意見、改良案、パッチなど、歓迎します。


以下の環境で、ある程度の動作確認を行っています。

- CentOS 6 x86_64  (Python 2.6.6)
- CentOS 7 x86_64  (Python 2.7.5)
- FreeBSD 10.1-RELEASE-p10 amd64 (Python 2.7.10)
- OS X 10.9.5 (Python 2.7.5)
- Ubuntu 14.04.2 LTS x86_64  (Python 2.7.6)
- Windows 7   (Python 2.7.8 |Anaconda 2.1.0 (64-bit))
- Windows 8.1 (Python 2.7.8 |Anaconda 2.1.0 (32-bit))
- Windows 8.1 (Python 2.7.10 64bit (AMD64))


### adccliのインストール

PATHの通ったディレクトリにファイルadccli adcclient.py http_post.pyをコピーしてください。

adccliに実行許可を与えてください。



#### おもなオプション
`adccli --help`で、かんたんなヘルプメッセージが表示されます。

    --username ユーザー名
    --password パスワード … loginのときだけ指定が必要
    --url サーバURL

#### 設定ファイル
adccli用設定ファイル`adcclient.json`が、ホームディレクトリに自動的に作成されます。

オプション`--username`や`--URL`で指定した値は、設定ファイルに保存され、以後、デフォルト値として利用されるようになります。

Webのクッキーが設定ファイルに保存され、loginに成功した後は、ログイン状態が継続します。設定ファイルにパスワードは保存されません。


#### クライアントライブラリ adcclient.py

ADCサービスのAPIを呼び出すためのライブラリです。

adccliを使わずに、adcclient.py経由で、自作プログラムからWeb APIを利用することも容易です。


#### プロキシーサーバ経由での利用

環境変数`http_proxy`、`no_proxy`を参照して、プロキシーサーバ経由で動作します。


## adccliを用いたADCサービス

### loginする

    adccli --URL='http://das-adc.appspot.com/' --username='USERNAME' --password='PASSWORD' login


### logoutする

    adccli logout

### loginしたときのユーザー名を確認する

    adccli whoami

### テスト期間中と、コンテスト開始前の準備期間中に実行可能な機能

#### 自作問題をアップロードする

    adccli post-user-q 問題番号 ファイル名

#### アップロード済の自作問題の一覧リストを見る

    adccli get-user-q

#### 自作問題をダウンロードする

    adccli get-user-q 問題番号

#### 自作問題を削除する

    adccli delete-user-q 問題番号

#### 自作問題を差し換える

    adccli put-user-q 問題番号 ファイル名

### テスト期間中と、コンテスト開始後に実行可能な機能

#### 出題問題の番号を確認する

コンテストがスタートしたら、まず、出題された問題番号の一覧リストを取得してください。

    adccli get-q

ファイルに出力したい場合

    adccli --output ファイル名 get-q
    例
    adccli --output Q-list.txt get-q


#### 出題問題をダウンロードする

出題番号を指定して、出題された問題データをダウンロードしてください。

    adccli get-q 出題番号
    例
    adccli get-q 1

ファイルに出力したい場合

    adccli --output ファイル名 get-q 出題番号
    例
    adccli --output Q1.txt get-q 1

#### 回答をアップロードする

    adccli put-a 出題番号 ファイル名
    例
    adccli put-a 1 A1.txt


### テスト期間中に実行可能な機能

#### アップロード済の回答データの一覧リストを見る

    adccli get-a

#### アップロード済の回答データをダウンロードする

    adccli get-a 出題番号

#### アップロード済の回答データを削除する

    adccli delete-a 出題番号


### スコアを見る

開発中です。


## curlを使ってADCサービスを利用する

adccliは実行のためにpythonの実行環境が必要となりますが、その代りに、curl単体でも、ADCサービスを利用できます。

また、自作プログラムからADCサービスAPIを直接呼び出したい方は、参考にしてください。curlに`-v`オプションをつけて実行すると、より詳細な情報が得られます。

ちなみに、das-adc.appspot.comへは、httpsでもhttpでもアクセスできるようになっています。

### loginする

    curl -H "Accept: application/json" -H "Content-type: application/json" -X POST -d '{"username":"USERNAME", "password":"PASSWORD"}' --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/login

- `USERNAME`と`PASSWORD`の部分を、実際のアカウントのものへ差し換えてください。
- `CURL_COOKIES`の部分では、クッキーを保存するファイル名を指定します。他人から見られないように、アクセス制限をしてください（例: `chmod 600 CURL_COOKIES`）。

loginに成功した場合、以下のような応答が来ます。JSON形式になっています。

    {"msg": "login OK"}

### logoutする

以下のどちらでもかまいません。

    curl -X POST -d 'dummy' --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/logout

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/logout

### loginしたときのユーザー名を確認する

HTML形式で応答を得る方法

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/logout

JSON形式で応答を得る方法

    curl -H "Accept: application/json" -H "Content-type: application/json" --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/whoami


### テスト期間中と、コンテスト開始前の準備期間中に実行可能な機能

#### 自作問題をアップロードする

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES --form "qfile=@QFILENAME" https://das-adc.appspot.com/user/USERNAME/Q/QNUMBER

- QFILENAMEは、問題ファイルのファイル名を指定してください
- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBERは、1、2、3のいずれかを指定してください。

#### 自作問題をダウンロードする

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/user/USERNAME/Q/QNUMBER

- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBERは、1、2、3のいずれかを指定してください。

#### 自作問題を削除する

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES -X DELETE https://das-adc.appspot.com/user/USERNAME/Q/QNUMBER

- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBERは、1、2、3のいずれかを指定してください。

#### 自作問題を差し換える

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES -H "Content-Type: text/plain" --upload-file QFILENAME https://das-adc.appspot.com/user/USERNAME/Q/QNUMBER

- QFILENAMEは、問題ファイルのファイル名を指定してください
- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBERは、1、2、3のいずれかを指定してください。

すでにQNUMBERの問題がアップロード済の場合に、問題データが差し換えられます。新規登録はしません。

差し換えに成功したときの応答メッセージの例

    PUT OK update 1 {USERNAME} Q{QNUMBER} size ***x*** line_num ***

差し換えなかった（新規登録もしない）ときの応答メッセージの例

    PUT OK update 0 {USERNAME} Q{QNUMBER} size ***x*** line_num ***



### テスト期間中と、コンテスト開始後に実行可能な機能

<a name="GETQ"></a>
#### 出題問題の番号を確認する

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/Q

以下のような応答が返ってきます。

    Q1
    Q2
    Q3
    Q4
    Q5

- 番号は1から順番に、通し番号で割り振っています。歯抜けはありません。最後が`Q5`ならば、全部で5問あるという意味です。
- `Q`がついていますが、問題をダウンロードするときは、`Q`はつけません。


#### 出題問題をダウンロードする

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/Q/QNUMBER

- QNUMBERには、[出題問題](#GETQ)の整数値を指定します。`Q`はつけません。
- ファイルに保存したい場合は、curlの`-o`オプションを使用します

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/Q/QNUMBER -o QFILENAME


#### 回答をアップロードする

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES -H "Content-Type: text/plain" --upload-file AFILENAME https://das-adc.appspot.com/A/USERNAME/Q/QNUMBER

- AFILENAMEは、回答ファイルのファイル名を指定してください
- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBERには、[出題問題の番号](#GETQ)の整数値を指定します。ただし`Q`はつけません。


**2015年7月10日現在、回答チェック機能は、まだ開発途中です。**

以下のような応答が返ってきます。

    i= 0
    check_1 True
    check_2 True
    check_3 True
    check_4 True
    check_5 True
    check_6 True
    judges =  [True]
    Get 3.141592 point [DUMMY]

この出力形式は、2014年のアルゴリズムデザインコンテストで提供した[回答チェックツール](http://www.sig-sldm.org/nlcheck.html)とほぼ同じです。ただし、ファイル名のチェック処理は、2015年では不要なため、省いています。

- `judges =  [True]`ならば、回答は正しいという意味です。
- *解の品質*は、まだ考慮していません。pointはダミーとして出力しています。


### テスト期間中に実行可能な機能

コンテスト本番中には、以下の機能は実行できなくなります。

<a name="GETA"></a>
#### アップロード済の回答データの一覧リストを見る

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/A/USERNAME

- USERNAMEは、アカウントのユーザー名を指定してください

応答の例

    A2
    A6

- アップ済の回答データの番号が返ってきます。番号は、出題番号の頭に`A`をつけたものです


#### アップロード済の回答データをダウンロードする

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES https://das-adc.appspot.com/A/USERNAME/Q/QNUMBER

- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBER、[回答済の出題問題](#GETA)の整数値を指定します。`A`はつけません。


#### アップロード済の回答データを削除する

    curl --cookie-jar CURL_COOKIES --cookie CURL_COOKIES -X DELETE https://das-adc.appspot.com/A/USERNAME/Q/QNUMBER

- USERNAMEは、アカウントのユーザー名を指定してください
- QNUMBER、[回答済の出題問題](#GETA)の整数値を指定します。`A`はつけません。

応答の例

    DELETE A6


### スコアを見る


**開発中です。**



## adccliの管理者専用の機能

一般ユーザー権限では利用できません。

### ユーザー作成

    adccli create-user 'ユーザー名' 'パスワード'  '説明など' ユーザーID グループID

|グループID |意味       |
|-----------|-----------|
|0          |管理者用   |
|1000       |ADC参加者用|

adcusers_in.pyからユーザーを一括作成

    adccli create-users

### ユーザー削除

    adccli delete-user ユーザー名1 [ユーザー名2 ...]


### 問題データへのアクセス

管理権限を持ったユーザーは、`get-user-q`、`post-user-q`、`put-user-q`、`delete-user-q`にて、全ユーザの問題に対して、アップロード、ダウンロード、削除が可能。

ユーザー名は`--username`オプションで指定する（設定ファイルにユーザー名が書き込まれて、以後のデフォルト値になるので注意）。

全問題のリスト

    adccli get-admin-q-all

出題番号、作者、問題番号の対応関係を出力する

    adccli get-admin-q-list

出題番号を決める（シャフルする）

    adccli put-admin-q-list

出題番号を消去する

    adccli delete-admin-q-list

